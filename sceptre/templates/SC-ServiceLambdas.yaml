AWSTemplateFormatVersion: 2010-09-09
Description: ThreatTools API Service Lambdas

Parameters:
  DevelopmentTeam:
    Type: String
    Description: SSM Parameter for team owning the created resources.
  DevelopmentEnvironment:
    Type: String
    Description: SSM Parameter for development environment this will live in.
  SSOHost:
    Type: String
    Description: SSO endpoint used by the Authorizer lambda
    Default: "sso.gdcorp.tools"
  DXVpcSecurityGroups:
    Type: String
    Description: SSM Parameter for private dx app security group id
  DXVpcSubnetIds:
    Type: CommaDelimitedList
    Description: SSM Parameter for private dx app subnet ids
  apivoidSHA1:
    Type: String
    Description: SHA1 hash of the apivoid lambda source
    Default: ""
  cmapSHA1:
    Type: String
    Description: SHA1 hash of the cmap lambda source
    Default: ""
  nvdSHA1:
    Type: String
    Description: SHA1 hash of the nvd lambda source
    Default: ""
  passivetotalSHA1:
    Type: String
    Description: SHA1 hash of the passivetotal lambda source
    Default: ""
  recordedfutureSHA1:
    Type: String
    Description: SHA1 hash of the recordedfuture lambda source
    Default: ""
  servicenowSHA1:
    Type: String
    Description: SHA1 hash of the servicenow lambda source
    Default: ""
  shodanSHA1:
    Type: String
    Description: SHA1 hash of the shodan lambda source
    Default: ""
  sucuriSHA1:
    Type: String
    Description: SHA1 hash of the sucuri lambda source
    Default: ""
  taniumSHA1:
    Type: String
    Description: SHA1 hash of the tanium lambda source
    Default: ""
  trustarSHA1:
    Type: String
    Description: SHA1 hash of the trustar lambda source
    Default: ""
  urlhausSHA1:
    Type: String
    Description: SHA1 hash of the urlhaus lambda source
    Default: ""
  urlscanioSHA1:
    Type: String
    Description: SHA1 hash of the urlscanio lambda source
    Default: ""
  virustotalSHA1:
    Type: String
    Description: SHA1 hash of the virustotal lambda source
    Default: ""
  whoisSHA1:
    Type: String
    Description: SHA1 hash of the whois lambda source
    Default: ""
  zerobounceSHA1:
    Type: String
    Description: SHA1 hash of the zerobounce lambda source
    Default: ""

Resources:
  apivoidLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: apivoidLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub apivoid/${apivoidSHA1}
        - Key: Handler
          Value: apivoid
        - Key: LambdaName
          Value: apivoid
        - Key: LambdaDescription
          Value: !Sub apivoid lambda (${apivoidSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  apivoidLambdaPermission:
    DependsOn: apivoidLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: apivoidLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:apivoid
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  apivoidSNSSubscription:
    DependsOn: apivoidLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: apivoidSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:apivoid
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  apivoidLambdaEventInvokeConfig:
    DependsOn: apivoidLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: apivoid
      Qualifier: $LATEST

  apivoidLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/apivoid
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL"]}'

  apivoidAppSecSubscriptionFilter:
    DependsOn: apivoidLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: apivoidAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/apivoid
      Tags:
          - Key: doNotShutDown
            Value: "true"

  cmapLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: cmapLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub cmap/${cmapSHA1}
        - Key: Handler
          Value: cmap
        - Key: LambdaName
          Value: cmap
        - Key: LambdaDescription
          Value: !Sub cmap lambda (${cmapSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  cmapLambdaPermission:
    DependsOn: cmapLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: cmapLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:cmap
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  cmapSNSSubscription:
    DependsOn: cmapLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: cmapSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:cmap
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  cmapLambdaEventInvokeConfig:
    DependsOn: cmapLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: cmap
      Qualifier: $LATEST

  cmapLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/cmap
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"], "actions": {"Run": {"requiredADGroups": ["ENG-Threat Research", "ENG-DCU"]}, "ViewPII": {"requiredADGroups": ["ENG-Threat Research", "ENG-DCU"]}}}'

  cmapAppSecSubscriptionFilter:
    DependsOn: cmapLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: cmapAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/cmap
      Tags:
          - Key: doNotShutDown
            Value: "true"

  nvdLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: nvdLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub nvd/${nvdSHA1}
        - Key: Handler
          Value: nvd
        - Key: LambdaName
          Value: nvd
        - Key: LambdaDescription
          Value: !Sub nvd lambda (${nvdSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  nvdLambdaPermission:
    DependsOn: nvdLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: nvdLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:nvd
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  nvdSNSSubscription:
    DependsOn: nvdLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: nvdSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:nvd
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  nvdLambdaEventInvokeConfig:
    DependsOn: nvdLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: nvd
      Qualifier: $LATEST

  nvdLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/nvd
      Type: String
      Value: '{"supportedIOCTypes": ["CVE"]}'

  nvdAppSecSubscriptionFilter:
    DependsOn: nvdLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: nvdAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/nvd
      Tags:
          - Key: doNotShutDown
            Value: "true"

  passivetotalLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: passivetotalLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub passivetotal/${passivetotalSHA1}
        - Key: Handler
          Value: passivetotal
        - Key: LambdaName
          Value: passivetotal
        - Key: LambdaDescription
          Value: !Sub passivetotal lambda (${passivetotalSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  passivetotalLambdaPermission:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: passivetotalLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:passivetotal
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  passivetotalSNSSubscription:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: passivetotalSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:passivetotal
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  passivetotalLambdaEventInvokeConfig:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: passivetotal
      Qualifier: $LATEST

  passivetotalLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/passivetotal
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP"]}'

  passivetotalAppSecSubscriptionFilter:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: passivetotalAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/passivetotal
      Tags:
          - Key: doNotShutDown
            Value: "true"

  recordedfutureLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: recordedfutureLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub recordedfuture/${recordedfutureSHA1}
        - Key: Handler
          Value: recordedfuture
        - Key: LambdaName
          Value: recordedfuture
        - Key: LambdaDescription
          Value: !Sub recordedfuture lambda (${recordedfutureSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  recordedfutureLambdaPermission:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: recordedfutureLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:recordedfuture
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  recordedfutureSNSSubscription:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: recordedfutureSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:recordedfuture
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  recordedfutureLambdaEventInvokeConfig:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: recordedfuture
      Qualifier: $LATEST

  recordedfutureLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/recordedfuture
      Type: String
      Value: '{"supportedIOCTypes": ["CVE", "IP", "MD5", "SHA1", "SHA256", "DOMAIN", "URL"]}'

  recordedfutureAppSecSubscriptionFilter:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: recordedfutureAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/recordedfuture
      Tags:
          - Key: doNotShutDown
            Value: "true"

  servicenowLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: servicenowLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub servicenow/${servicenowSHA1}
        - Key: Handler
          Value: servicenow
        - Key: LambdaName
          Value: servicenow
        - Key: LambdaDescription
          Value: !Sub servicenow lambda (${servicenowSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  servicenowLambdaPermission:
    DependsOn: servicenowLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: servicenowLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:servicenow
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  servicenowSNSSubscription:
    DependsOn: servicenowLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: servicenowSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:servicenow
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  servicenowLambdaEventInvokeConfig:
    DependsOn: servicenowLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: servicenow
      Qualifier: $LATEST

  servicenowLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/servicenow
      Type: String
      Value: '{"supportedIOCTypes": ["GODADDY_HOSTNAME"]}'

  servicenowAppSecSubscriptionFilter:
    DependsOn: servicenowLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: servicenowAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/servicenow
      Tags:
          - Key: doNotShutDown
            Value: "true"

  shodanLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: shodanLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub shodan/${shodanSHA1}
        - Key: Handler
          Value: shodan
        - Key: LambdaName
          Value: shodan
        - Key: LambdaDescription
          Value: !Sub shodan lambda (${shodanSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  shodanLambdaPermission:
    DependsOn: shodanLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: shodanLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:shodan
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  shodanSNSSubscription:
    DependsOn: shodanLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: shodanSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:shodan
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  shodanLambdaEventInvokeConfig:
    DependsOn: shodanLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: shodan
      Qualifier: $LATEST

  shodanLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/shodan
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP"]}'

  shodanAppSecSubscriptionFilter:
    DependsOn: shodanLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: shodanAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/shodan
      Tags:
          - Key: doNotShutDown
            Value: "true"

  sucuriLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: sucuriLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub sucuri/${sucuriSHA1}
        - Key: Handler
          Value: sucuri
        - Key: LambdaName
          Value: sucuri
        - Key: LambdaDescription
          Value: !Sub sucuri lambda (${sucuriSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  sucuriLambdaPermission:
    DependsOn: sucuriLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: sucuriLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:sucuri
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  sucuriSNSSubscription:
    DependsOn: sucuriLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: sucuriSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:sucuri
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  sucuriLambdaEventInvokeConfig:
    DependsOn: sucuriLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: sucuri
      Qualifier: $LATEST

  sucuriLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/sucuri
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"]}'

  sucuriAppSecSubscriptionFilter:
    DependsOn: sucuriLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: sucuriAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/sucuri
      Tags:
          - Key: doNotShutDown
            Value: "true"

  taniumLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: taniumLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub tanium/${taniumSHA1}
        - Key: Handler
          Value: tanium
        - Key: LambdaName
          Value: tanium
        - Key: LambdaDescription
          Value: !Sub tanium lambda (${taniumSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  taniumLambdaPermission:
    DependsOn: taniumLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: taniumLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:tanium
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  taniumSNSSubscription:
    DependsOn: taniumLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: taniumSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:tanium
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  taniumLambdaEventInvokeConfig:
    DependsOn: taniumLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: tanium
      Qualifier: $LATEST

  taniumLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/tanium
      Type: String
      Value: '{"supportedIOCTypes": []}'

  taniumAppSecSubscriptionFilter:
    DependsOn: taniumLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: taniumAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/tanium
      Tags:
          - Key: doNotShutDown
            Value: "true"

  trustarLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: trustarLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub trustar/${trustarSHA1}
        - Key: Handler
          Value: trustar-isac.handler
        - Key: LambdaName
          Value: trustar
        - Key: LambdaDescription
          Value: !Sub trustar lambda (${trustarSHA1})
        - Key: MemorySize
          Value: 128
        - Key: Runtime
          Value: python3.8
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  trustarLambdaPermission:
    DependsOn: trustarLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: trustarLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:trustar
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  trustarSNSSubscription:
    DependsOn: trustarLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: trustarSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:trustar
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  trustarLambdaEventInvokeConfig:
    DependsOn: trustarLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: trustar
      Qualifier: $LATEST

  trustarLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/trustar
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "MD5", "SHA1", "SHA256", "URL", "CVE", "EMAIL"]}'

  trustarAppSecSubscriptionFilter:
    DependsOn: trustarLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: trustarAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/trustar
      Tags:
          - Key: doNotShutDown
            Value: "true"

  urlhausLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: urlhausLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub urlhaus/${urlhausSHA1}
        - Key: Handler
          Value: urlhaus
        - Key: LambdaName
          Value: urlhaus
        - Key: LambdaDescription
          Value: !Sub urlhaus lambda (${urlhausSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  urlhausLambdaPermission:
    DependsOn: urlhausLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: urlhausLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlhaus
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  urlhausSNSSubscription:
    DependsOn: urlhausLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: urlhausSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlhaus
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  urlhausLambdaEventInvokeConfig:
    DependsOn: urlhausLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: urlhaus
      Qualifier: $LATEST

  urlhausLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/urlhaus
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL", "MD5", "SHA256"]}'

  urlhausAppSecSubscriptionFilter:
    DependsOn: urlhausLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: urlhausAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/urlhaus
      Tags:
          - Key: doNotShutDown
            Value: "true"

  urlscanioLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: urlscanioLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub urlscanio/${urlscanioSHA1}
        - Key: Handler
          Value: urlscanio
        - Key: LambdaName
          Value: urlscanio
        - Key: LambdaDescription
          Value: !Sub urlscanio lambda (${urlscanioSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  urlscanioLambdaPermission:
    DependsOn: urlscanioLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: urlscanioLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlscanio
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  urlscanioSNSSubscription:
    DependsOn: urlscanioLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: urlscanioSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlscanio
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  urlscanioLambdaEventInvokeConfig:
    DependsOn: urlscanioLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: urlscanio
      Qualifier: $LATEST

  urlscanioLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/urlscanio
      Type: String
      Value: '{"supportedIOCTypes": ["URL"]}'

  urlscanioAppSecSubscriptionFilter:
    DependsOn: urlscanioLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: urlscanioAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/urlscanio
      Tags:
          - Key: doNotShutDown
            Value: "true"

  virustotalLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: virustotalLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub virustotal/${virustotalSHA1}
        - Key: Handler
          Value: virustotal
        - Key: LambdaName
          Value: virustotal
        - Key: LambdaDescription
          Value: !Sub virustotal lambda (${virustotalSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  virustotalLambdaPermission:
    DependsOn: virustotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: virustotalLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:virustotal
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  virustotalSNSSubscription:
    DependsOn: virustotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: virustotalSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:virustotal
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  virustotalLambdaEventInvokeConfig:
    DependsOn: virustotalLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: virustotal
      Qualifier: $LATEST

  virustotalLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/virustotal
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL", "MD5", "SHA1", "SHA256"]}'

  virustotalAppSecSubscriptionFilter:
    DependsOn: virustotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: virustotalAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/virustotal
      Tags:
          - Key: doNotShutDown
            Value: "true"

  whoisLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: whoisLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub whois/${whoisSHA1}
        - Key: Handler
          Value: whois
        - Key: LambdaName
          Value: whois
        - Key: LambdaDescription
          Value: !Sub whois lambda (${whoisSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  whoisLambdaPermission:
    DependsOn: whoisLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: whoisLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:whois
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  whoisSNSSubscription:
    DependsOn: whoisLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: whoisSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:whois
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  whoisLambdaEventInvokeConfig:
    DependsOn: whoisLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: whois
      Qualifier: $LATEST

  whoisLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/whois
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"]}'

  whoisAppSecSubscriptionFilter:
    DependsOn: whoisLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: whoisAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/whois
      Tags:
          - Key: doNotShutDown
            Value: "true"

  zerobounceLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: zerobounceLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub zerobounce/${zerobounceSHA1}
        - Key: Handler
          Value: zerobounce
        - Key: LambdaName
          Value: zerobounce
        - Key: LambdaDescription
          Value: !Sub zerobounce lambda (${zerobounceSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 900
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}", "AWS_DEV_TEAM": "${DevelopmentTeam}", "AWS_DEV_ENV": "${DevelopmentEnvironment}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  zerobounceLambdaPermission:
    DependsOn: zerobounceLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: zerobounceLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:zerobounce
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  zerobounceSNSSubscription:
    DependsOn: zerobounceLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: zerobounceSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:zerobounce
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  zerobounceLambdaEventInvokeConfig:
    DependsOn: zerobounceLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: zerobounce
      Qualifier: $LATEST

  zerobounceLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/zerobounce
      Type: String
      Value: '{"supportedIOCTypes": ["EMAIL"]}'

  zerobounceAppSecSubscriptionFilter:
    DependsOn: zerobounceLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SubscriptionFilterAppSecurity
      ProvisionedProductName: zerobounceAppSecSubscriptionFilter
      ProvisioningArtifactName: 1.0.1
      ProvisioningParameters:
          - Key: CloudWatchLogGroup
            Value: /aws/lambda/zerobounce
      Tags:
          - Key: doNotShutDown
            Value: "true"
