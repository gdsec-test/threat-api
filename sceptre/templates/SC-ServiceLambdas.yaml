AWSTemplateFormatVersion: 2010-09-09
Description: ThreatTools API Service Lambdas

Parameters:
  DevelopmentTeam:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for team owning the created resources.
    Default: /AdminParams/Team/Name
    AllowedValues:
      - /AdminParams/Team/Name
  DevelopmentEnvironment:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for development environment this will live in.
    Default: /AdminParams/Team/Environment
    AllowedValues:
      - /AdminParams/Team/Environment
  SSOHost:
    Type: String
    Description: SSO endpoint used by the Authorizer lambda
    Default: "sso.gdcorp.tools"
  DXVpcSecurityGroups:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for private dx app security group id
    Default: /AdminParams/VPC/PrivateDXAPPSG
    AllowedValues:
      - /AdminParams/VPC/PrivateDXAPPSG
  DXVpcSubnetIds:
    Type: AWS::SSM::Parameter::Value<List<String>>
    Description: SSM Parameter for private dx app subnet ids
    Default: /AdminParams/VPC/DXAPPSubnets
    AllowedValues:
      - /AdminParams/VPC/DXAPPSubnets
  cmapSHA1:
    Type: String
    Description: SHA1 hash of the cmap lambda source
    Default: ""
  geoipSHA1:
    Type: String
    Description: SHA1 hash of the geoip lambda source
    Default: ""
  recordedfutureSHA1:
    Type: String
    Description: SHA1 hash of the recordedfuture lambda source
    Default: ""
  shodanSHA1:
    Type: String
    Description: SHA1 hash of the shodan lambda source
    Default: ""
  splunkSHA1:
    Type: String
    Description: SHA1 hash of the splunk lambda source
    Default: ""
  tester1SHA1:
    Type: String
    Description: SHA1 hash of the tester1 lambda source
    Default: ""
  urlhausSHA1:
    Type: String
    Description: SHA1 hash of the urlhaus lambda source
    Default: ""
  virustotalSHA1:
    Type: String
    Description: SHA1 hash of the virustotal lambda source
    Default: ""
  whoisSHA1:
    Type: String
    Description: SHA1 hash of the whois lambda source
    Default: ""

Resources:
  cmapLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: cmapLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub cmap/${cmapSHA1}
        - Key: Handler
          Value: cmap
        - Key: LambdaName
          Value: cmap
        - Key: LambdaDescription
          Value: !Sub cmap lambda (${cmapSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  cmapLambdaPermission:
    DependsOn: cmapLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: cmapLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:cmap
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  cmapSNSSubscription:
    DependsOn: cmapLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: cmapSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:cmap
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  cmapLambdaEventInvokeConfig:
    DependsOn: cmapLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: cmap
      Qualifier: $LATEST

  cmapLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/cmap
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"], "actions": {"Run": {"requiredADGroups": ["Eng-ThreatIntel"]}}}'

  geoipLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: geoipLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub geoip/${geoipSHA1}
        - Key: Handler
          Value: geoip
        - Key: LambdaName
          Value: geoip
        - Key: LambdaDescription
          Value: !Sub geoip lambda (${geoipSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  geoipLambdaPermission:
    DependsOn: geoipLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: geoipLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:geoip
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  geoipSNSSubscription:
    DependsOn: geoipLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: geoipSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:geoip
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  geoipLambdaEventInvokeConfig:
    DependsOn: geoipLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: geoip
      Qualifier: $LATEST

  geoipLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/geoip
      Type: String
      Value: '{"supportedIOCTypes": ["IP"]}'

  recordedfutureLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: recordedfutureLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub recordedfuture/${recordedfutureSHA1}
        - Key: Handler
          Value: recordedfuture
        - Key: LambdaName
          Value: recordedfuture
        - Key: LambdaDescription
          Value: !Sub recordedfuture lambda (${recordedfutureSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  recordedfutureLambdaPermission:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: recordedfutureLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:recordedfuture
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  recordedfutureSNSSubscription:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: recordedfutureSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:recordedfuture
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  recordedfutureLambdaEventInvokeConfig:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: recordedfuture
      Qualifier: $LATEST

  recordedfutureLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/recordedfuture
      Type: String
      Value: '{"supportedIOCTypes": ["CVE", "IP"]}'

  shodanLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: shodanLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub shodan/${shodanSHA1}
        - Key: Handler
          Value: shodan
        - Key: LambdaName
          Value: shodan
        - Key: LambdaDescription
          Value: !Sub shodan lambda (${shodanSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  shodanLambdaPermission:
    DependsOn: shodanLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: shodanLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:shodan
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  shodanSNSSubscription:
    DependsOn: shodanLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: shodanSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:shodan
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  shodanLambdaEventInvokeConfig:
    DependsOn: shodanLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: shodan
      Qualifier: $LATEST

  shodanLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/shodan
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP"]}'

  splunkLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: splunkLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub splunk/${splunkSHA1}
        - Key: Handler
          Value: splunk
        - Key: LambdaName
          Value: splunk
        - Key: LambdaDescription
          Value: !Sub splunk lambda (${splunkSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 300
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  splunkLambdaPermission:
    DependsOn: splunkLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: splunkLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:splunk
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  splunkSNSSubscription:
    DependsOn: splunkLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: splunkSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:splunk
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  splunkLambdaEventInvokeConfig:
    DependsOn: splunkLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: splunk
      Qualifier: $LATEST

  splunkLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/splunk
      Type: String
      Value: '{"supportedIOCTypes": ["GODADDY_USERNAME", "IP", "CVE", "AWSHOSTNAME"], "actions": {"ReadSplunk": {"requiredADGroups": ["Eng-ThreatIntel"]}}}'

  tester1LambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: tester1LambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub tester1/${tester1SHA1}
        - Key: Handler
          Value: tester1.handler
        - Key: LambdaName
          Value: tester1
        - Key: LambdaDescription
          Value: !Sub tester1 lambda (${tester1SHA1})
        - Key: MemorySize
          Value: 128
        - Key: Runtime
          Value: python3.7
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  tester1LambdaPermission:
    DependsOn: tester1LambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: tester1LambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:tester1
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  tester1SNSSubscription:
    DependsOn: tester1LambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: tester1SNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:tester1
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  tester1LambdaEventInvokeConfig:
    DependsOn: tester1LambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: tester1
      Qualifier: $LATEST

  tester1LambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/tester1
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "UNKNOWN"]}'

  urlhausLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: urlhausLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub urlhaus/${urlhausSHA1}
        - Key: Handler
          Value: urlhaus
        - Key: LambdaName
          Value: urlhaus
        - Key: LambdaDescription
          Value: !Sub urlhaus lambda (${urlhausSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  urlhausLambdaPermission:
    DependsOn: urlhausLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: urlhausLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlhaus
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  urlhausSNSSubscription:
    DependsOn: urlhausLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: urlhausSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlhaus
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  urlhausLambdaEventInvokeConfig:
    DependsOn: urlhausLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: urlhaus
      Qualifier: $LATEST

  urlhausLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/urlhaus
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL", "MD5", "SHA256"]}'

  virustotalLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: virustotalLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub virustotal/${virustotalSHA1}
        - Key: Handler
          Value: virustotal
        - Key: LambdaName
          Value: virustotal
        - Key: LambdaDescription
          Value: !Sub virustotal lambda (${virustotalSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 15
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  virustotalLambdaPermission:
    DependsOn: virustotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: virustotalLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:virustotal
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  virustotalSNSSubscription:
    DependsOn: virustotalLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: virustotalSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:virustotal
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  virustotalLambdaEventInvokeConfig:
    DependsOn: virustotalLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: virustotal
      Qualifier: $LATEST

  virustotalLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/virustotal
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL", "MD5", "SHA256"]}'

  whoisLambdaFunction:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: Lambda
      ProvisioningArtifactName: 2.3.0
      ProvisionedProductName: whoisLambdaFunction
      ProvisioningParameters:
        - Key: S3Bucket
          Value: !Sub gd-${DevelopmentTeam}-${DevelopmentEnvironment}-code-bucket
        - Key: S3Key
          Value: !Sub whois/${whoisSHA1}
        - Key: Handler
          Value: whois
        - Key: LambdaName
          Value: whois
        - Key: LambdaDescription
          Value: !Sub whois lambda (${whoisSHA1})
        - Key: MemorySize
          Value: 256
        - Key: Runtime
          Value: go1.x
        - Key: Timeout
          Value: 300
        - Key: CustomIAMRoleNameSuffix
          Value: ThreatRole
        - Key: EnvironmentVariablesJson
          Value: !Sub '{"SSO_HOST": "${SSOHost}"}'
        - Key: VpcSecurityGroups
          Value: !Ref DXVpcSecurityGroups
        - Key: VpcSubnetIds
          Value: !Join [ ",", !Ref DXVpcSubnetIds ]
      Tags:
        - Key: doNotShutDown
          Value: true

  whoisLambdaPermission:
    DependsOn: whoisLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: LambdaPermission
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: whoisLambdaPermission
      ProvisioningParameters:
        - Key: Action
          Value: lambda:InvokeFunction
        - Key: FunctionName
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:whois
        - Key: Principal
          Value: sns.amazonaws.com
        - Key: SourceArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
      Tags:
        - Key: doNotShutDown
          Value: true

  whoisSNSSubscription:
    DependsOn: whoisLambdaFunction
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: SNSSubscription
      ProvisioningArtifactName: 1.0.1
      ProvisionedProductName: whoisSNSSubscription
      ProvisioningParameters:
        - Key: Protocol
          Value: lambda
        - Key: TopicArn
          Value: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests
        - Key: Endpoint
          Value: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:whois
        - Key: Region
          Value: !Sub ${AWS::Region}
      Tags:
        - Key: doNotShutDown
          Value: true

  whoisLambdaEventInvokeConfig:
    DependsOn: whoisLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: whois
      Qualifier: $LATEST

  whoisLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/whois
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"]}'
