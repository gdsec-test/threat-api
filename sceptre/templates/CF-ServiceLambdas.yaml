AWSTemplateFormatVersion: 2010-09-09
Description: ThreatTools API Service Lambdas

Parameters:
  cmapSHA1:
    Type: String
    Description: SHA1 hash of the cmap lambda source
    Default: ""
  geoipSHA1:
    Type: String
    Description: SHA1 hash of the geoip lambda source
    Default: ""
  passivetotalSHA1:
    Type: String
    Description: SHA1 hash of the passivetotal lambda source
    Default: ""
  recordedfutureSHA1:
    Type: String
    Description: SHA1 hash of the recordedfuture lambda source
    Default: ""
  servicenowSHA1:
    Type: String
    Description: SHA1 hash of the servicenow lambda source
    Default: ""
  shodanSHA1:
    Type: String
    Description: SHA1 hash of the shodan lambda source
    Default: ""
  splunkSHA1:
    Type: String
    Description: SHA1 hash of the splunk lambda source
    Default: ""
  urlhausSHA1:
    Type: String
    Description: SHA1 hash of the urlhaus lambda source
    Default: ""
  virustotalSHA1:
    Type: String
    Description: SHA1 hash of the virustotal lambda source
    Default: ""
  whoisSHA1:
    Type: String
    Description: SHA1 hash of the whois lambda source
    Default: ""

Resources:
  cmapLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub cmap/${cmapSHA1}
      Description: !Sub cmap lambda (${cmapSHA1})
      FunctionName: cmap
      Handler: cmap
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  cmapLambdaPermission:
    DependsOn: cmapLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:cmap
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  cmapSNSSubscription:
    DependsOn: cmapLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt cmapLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  cmapLambdaEventInvokeConfig:
    DependsOn: cmapLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: cmap
      Qualifier: $LATEST

  cmapLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/cmap
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"], "actions": {"Run": {"requiredADGroups": ["ENG-Threat Research", "ENG-DCU"]}, "ViewPII": {"requiredADGroups": ["ENG-Threat Research", "ENG-DCU"]}}}'

  geoipLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub geoip/${geoipSHA1}
      Description: !Sub geoip lambda (${geoipSHA1})
      FunctionName: geoip
      Handler: geoip
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  geoipLambdaPermission:
    DependsOn: geoipLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:geoip
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  geoipSNSSubscription:
    DependsOn: geoipLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt geoipLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  geoipLambdaEventInvokeConfig:
    DependsOn: geoipLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: geoip
      Qualifier: $LATEST

  geoipLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/geoip
      Type: String
      Value: '{"supportedIOCTypes": ["IP"]}'

  passivetotalLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub passivetotal/${passivetotalSHA1}
      Description: !Sub passivetotal lambda (${passivetotalSHA1})
      FunctionName: passivetotal
      Handler: passivetotal
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  passivetotalLambdaPermission:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:passivetotal
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  passivetotalSNSSubscription:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt passivetotalLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  passivetotalLambdaEventInvokeConfig:
    DependsOn: passivetotalLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: passivetotal
      Qualifier: $LATEST

  passivetotalLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/passivetotal
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP"]}'

  recordedfutureLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub recordedfuture/${recordedfutureSHA1}
      Description: !Sub recordedfuture lambda (${recordedfutureSHA1})
      FunctionName: recordedfuture
      Handler: recordedfuture
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  recordedfutureLambdaPermission:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:recordedfuture
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  recordedfutureSNSSubscription:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt recordedfutureLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  recordedfutureLambdaEventInvokeConfig:
    DependsOn: recordedfutureLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: recordedfuture
      Qualifier: $LATEST

  recordedfutureLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/recordedfuture
      Type: String
      Value: '{"supportedIOCTypes": ["CVE", "IP", "MD5", "SHA1", "SHA256"]}'

  servicenowLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub servicenow/${servicenowSHA1}
      Description: !Sub servicenow lambda (${servicenowSHA1})
      FunctionName: servicenow
      Handler: servicenow
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  servicenowLambdaPermission:
    DependsOn: servicenowLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:servicenow
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  servicenowSNSSubscription:
    DependsOn: servicenowLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt servicenowLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  servicenowLambdaEventInvokeConfig:
    DependsOn: servicenowLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: servicenow
      Qualifier: $LATEST

  servicenowLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/servicenow
      Type: String
      Value: '{"supportedIOCTypes": ["HOSTNAME"]}'

  shodanLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub shodan/${shodanSHA1}
      Description: !Sub shodan lambda (${shodanSHA1})
      FunctionName: shodan
      Handler: shodan
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  shodanLambdaPermission:
    DependsOn: shodanLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:shodan
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  shodanSNSSubscription:
    DependsOn: shodanLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt shodanLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  shodanLambdaEventInvokeConfig:
    DependsOn: shodanLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: shodan
      Qualifier: $LATEST

  shodanLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/shodan
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP"]}'

  splunkLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub splunk/${splunkSHA1}
      Description: !Sub splunk lambda (${splunkSHA1})
      FunctionName: splunk
      Handler: splunk
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 300

  splunkLambdaPermission:
    DependsOn: splunkLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:splunk
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  splunkSNSSubscription:
    DependsOn: splunkLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt splunkLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  splunkLambdaEventInvokeConfig:
    DependsOn: splunkLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: splunk
      Qualifier: $LATEST

  splunkLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/splunk
      Type: String
      Value: '{"supportedIOCTypes": ["GODADDY_USERNAME", "IP", "CVE", "AWSHOSTNAME"], "actions": {"ReadSplunk": {"requiredADGroups": ["ENG-Threat Research", "ENG-DCU"]}}}'

  urlhausLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub urlhaus/${urlhausSHA1}
      Description: !Sub urlhaus lambda (${urlhausSHA1})
      FunctionName: urlhaus
      Handler: urlhaus
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  urlhausLambdaPermission:
    DependsOn: urlhausLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:urlhaus
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  urlhausSNSSubscription:
    DependsOn: urlhausLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt urlhausLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  urlhausLambdaEventInvokeConfig:
    DependsOn: urlhausLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: urlhaus
      Qualifier: $LATEST

  urlhausLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/urlhaus
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL", "MD5", "SHA256"]}'

  virustotalLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub virustotal/${virustotalSHA1}
      Description: !Sub virustotal lambda (${virustotalSHA1})
      FunctionName: virustotal
      Handler: virustotal
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 15

  virustotalLambdaPermission:
    DependsOn: virustotalLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:virustotal
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  virustotalSNSSubscription:
    DependsOn: virustotalLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt virustotalLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  virustotalLambdaEventInvokeConfig:
    DependsOn: virustotalLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: virustotal
      Qualifier: $LATEST

  virustotalLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/virustotal
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN", "IP", "URL", "MD5", "SHA256"]}'

  whoisLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: !Sub gd-threattools-${AWS::AccountId}-code-bucket
        S3Key: !Sub whois/${whoisSHA1}
      Description: !Sub whois lambda (${whoisSHA1})
      FunctionName: whois
      Handler: whois
      MemorySize: 256
      Role: !Sub arn:aws:iam::${AWS::AccountId}:role/threattools-custom-ThreatRole
      Runtime: go1.x
      Timeout: 300

  whoisLambdaPermission:
    DependsOn: whoisLambdaFunction
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:whois
      Principal: sns.amazonaws.com
      SourceArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  whoisSNSSubscription:
    DependsOn: whoisLambdaFunction
    Type: AWS::SNS::Subscription
    Properties:
      Endpoint: !GetAtt whoisLambdaFunction.Arn
      Protocol: lambda
      TopicArn: !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:JobRequests

  whoisLambdaEventInvokeConfig:
    DependsOn: whoisLambdaFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      DestinationConfig:
        OnSuccess:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobResponses
        OnFailure:
          Destination: !Sub arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:JobFailures
      FunctionName: whois
      Qualifier: $LATEST

  whoisLambdaMetadata:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /ThreatTools/Modules/whois
      Type: String
      Value: '{"supportedIOCTypes": ["DOMAIN"]}'
