AWSTemplateFormatVersion: 2010-09-09
Description: CloudWatch Alarm
Parameters:
  ClusterName:
    Type: String
  ServiceName:
    Type: String
  DevelopmentTeam:
    Type: String
  DevelopmentEnvironment:
    Type: String
  LoadBalancerName:
    Type: String
  ProjectCode:
    Type: String
    Default: "ThreatAPI"
  SlackSnsTopicName:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SNS Topic Name, which has Slack webhook to send messages
    Default: /AdminParams/SNS/AlarmNotificationTopic
Resources:
  APIGatewayCountTest:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:warning-moog-${DevelopmentTeam}-${DevelopmentEnvironment}
        - !Sub ${SlackSnsTopicName}
      OKActions:
        - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:warning-moog-${DevelopmentTeam}-${DevelopmentEnvironment}
        - !Sub ${SlackSnsTopicName}
      AlarmDescription: !Sub Testing Request Count APIGateway
      AlarmName: !Sub "${ProjectCode}: Number of request hits ${DevelopmentEnvironment}"
      ComparisonOperator: GreaterThanThreshold
      DatapointsToAlarm: 1
      EvaluationPeriods: 10
      MetricName: 'Count'
      Namespace: 'AWS/ApiGateway'
      Period: 60
      Statistic: Average
      Threshold: 1
      Unit: Count

#  APIGateway500ErrorCount:
#    Type: AWS::CloudWatch::Alarm
#    Properties:
#      AlarmActions:
#        - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:warning-moog-${DevelopmentTeam}-${DevelopmentEnvironment}
#        - !Sub ${SlackSnsTopicName}
#      OKActions:
#        - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:warning-moog-${DevelopmentTeam}-${DevelopmentEnvironment}
#        - !Sub ${SlackSnsTopicName}
#      AlarmDescription: !Sub Fires when a 5xx errors occurs at APIGateway
#      AlarmName: !Sub "${ProjectCode}: 5xx error from APIGateway  ${DevelopmentEnvironment}"
#      ComparisonOperator: GreaterThanThreshold
#      DatapointsToAlarm: 1
#      EvaluationPeriods: 10
#      MetricName: '5XXError'
#      Namespace: 'AWS/ApiGateway'
#      Period: 60
#      Statistic: Average
#      Threshold: 1
#      Unit: Count
