const AWS = require('aws-sdk');
// strange way to support CommonJS in node-fetch https://github.com/node-fetch/node-fetch#commonjs

const Logger = require('./src/logger');
const createCVETableIfNotExist = require('./src/createCVETableIfNotExist');
const getSecretsAndParams = require('./src/getSecretsAndParams');
const getFreshCVEsFromNVD = require('./src/getFreshCVEsFromNVD');
const getCVEsFromDB = require('./src/getCVEsFromDB');
const updateAndNotifyCVEs = require('./src/updateAndNotifyCVEs');

// Handler
async function handler(event, context = {}) {
  const region = process.env.AWS_REGION || 'us-west-2'; // provided by Lambda environment
  Logger.init({
    region,
    streamName: context.logStreamName,
    groupName: context.logGroupName
  });
  const now = new Date();
  Logger.log('Function start at ' + now.toUTCString());
  const ok = await createCVETableIfNotExist({ region });
  if (!ok) {
    return Promise.resolve(false);
  }
  const secretsAndParams = await getSecretsAndParams({ region });
  const freshCVEs = await getFreshCVEsFromNVD(secretsAndParams);
  var dynamodb = new AWS.DynamoDB({ region, maxRetries: 3, sslEnabled: true });
  const CVEsFromDB = await getCVEsFromDB({ dynamodb });
  updateAndNotifyCVEs({
    freshCVEs,
    CVEsFromDB,
    dynamodb,
    params: secretsAndParams
  });
  Logger.flushLogs();
  return context.logStreamName;
}

// handler();
// async function getAccountId () {
//   const sts = new AWS.STS();
//   const { Account: account } = await sts.getCallerIdentity({}).promise();
//   return account;
// }
handler.handler = handler;
module.exports = handler;
exports.handler = handler;
