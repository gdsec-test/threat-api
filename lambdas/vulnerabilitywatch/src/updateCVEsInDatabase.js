const getCVEScore = require('./getCVEScore');
const saveCVE = require('./saveCVE');
const Logger = require('./logger');
module.exports = async function updateCVEsInDatabase({
  freshCVEs,
  CVEsFromDB,
  dynamodb
}) {
  const updatedCVEs = [];
  const newCVEs = [];
  Logger.log('Start of update and notify CVEs');
  for (var [ID, freshCVE] of freshCVEs) {
    const newScore = getCVEScore(freshCVE);
    if (CVEsFromDB.has(ID)) {
      // DB contains existing CVE
      const dbCVEScore = CVEsFromDB.get(ID);
      if (dbCVEScore.toString() !== newScore.toString()) {
        // shoot slack message and update CVE
        updatedCVEs.push({
          ID,
          oldScore: dbCVEScore,
          score: newScore,
          data: freshCVE
        });
        await saveCVE({ item: freshCVE, dynamodb }); // CVE is present, but it needs to be updated in DB
      }
    } else {
      newCVEs.push({ ID, score: newScore, data: freshCVE });
      await saveCVE({ item: freshCVE, dynamodb }); // CVE is new and needs to be saved in DB
    }
  }
  Logger.log('Calling Slack to send notification');
  return {
    updatedCVEs,
    newCVEs
  };
};
