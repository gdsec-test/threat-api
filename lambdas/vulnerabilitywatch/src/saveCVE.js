const { TABLE_NAME } = require('./const');
const getCVEScore = require('./getCVEScore');
const Logger = require('./logger');
module.exports = async function saveCVE({ item, dynamodb }) {
  const { cve = {}, impact = {}, publishedDate, lastModifiedDate } = item;
  const {
    CVE_data_meta: { ID }
  } = cve;
  const {
    baseMetricV3: { cvssV3: { baseSeverity } = {} } = {},
    baseMetricV2: { cvssV2: { baseSeverity: baseSeverity2 } = {} } = {}
  } = impact;

  var params = {
    Item: {
      cve_id: {
        S: ID
      },
      score: {
        N: '' + getCVEScore(item)
      },
      severity: {
        S: '' + (baseSeverity || baseSeverity2 || '')
      },
      publishedDate: {
        S: publishedDate
      },
      lastModifiedDate: {
        S: lastModifiedDate
      },
      report: {
        B: Buffer.from(JSON.stringify(item), 'base64').toString('utf8')
      }
    },
    ReturnConsumedCapacity: 'TOTAL',
    TableName: TABLE_NAME
  };
  Logger.log('Saving CVE in DB ' + ID);
  return new Promise((resolve) => {
    dynamodb.putItem(params, function(err, data) {
      if (err) {
        Logger.log('Could not save CVE ' + ID + 'in DB:' + JSON.stringify(err));
      } else {
        Logger.log('Successsfully saved CVE:' + ID);
      }
      resolve({ err, data });
    });
  });
};
