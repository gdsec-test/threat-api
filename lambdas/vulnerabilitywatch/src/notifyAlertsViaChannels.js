const Logger = require('./logger');
const { slack } = require('./alertProviders/slack');

const CHANNEL_PROVIDERS = {
  slack
};

async function notifyAlertsViaChannels({ updatedCVEs, newCVEs, params }) {
  const { periodDays, cveCatalogURL, configs = [] } = params;
  Logger.log('Calling Slack to send notification');
  return await Promise.all(
    configs.map(async (config) => {
      const {
        input: { cvssRange = [] },
        output: { type, creds }
      } = config;
      const channelHandler = CHANNEL_PROVIDERS[type];
      if (!channelHandler) {
        Logger.error(
          `Unable to send notifications via ${type} channel, cause no handler code supported`
        );
        return Promise.resolve();
      }
      cvssRange[0] = parseFloat(cvssRange[0]) || 0;
      cvssRange[1] = parseFloat(cvssRange[1]) || 0;
      return await channelHandler({
        periodDays,
        updatedCVEs: updatedCVEs.filter(({ score }) => {
          return score >= cvssRange[0] && score <= cvssRange[1];
        }),
        newCVEs: newCVEs.filter(({ score }) => {
          return score >= cvssRange[0] && score <= cvssRange[1];
        }),
        cveCatalogURL,
        cvssRange,
        creds
      });
    })
  );
}

module.exports = {
  notifyAlertsViaChannels,
  CHANNEL_PROVIDERS
};
