const AWS = require('aws-sdk');
const { TABLE_DEFINITION, TABLE_NAME } = require('./const');

module.exports = async function createCVETableIfNotExist({ region }) {
  var dynamodb = new AWS.DynamoDB({ region, maxRetries: 3, sslEnabled: true });
  const tableNotExist = await new Promise((resolve) => {
    dynamodb.describeTable(
      {
        TableName: TABLE_NAME
      },
      function (err = {}, data) {
        if (err) {
          if (err.code === 'ResourceNotFoundException') {
            // table does not exist, we can create it
            resolve(true);
          } else {
            console.log('Unable to find table', JSON.stringify(err));
          }
        } else {
          resolve(false);
        }
      }
    );
  });
  return new Promise((resolve) => {
    if (tableNotExist) {
      dynamodb.createTable(TABLE_DEFINITION, function (err, data) {
        if (err) {
          console.log('Unable to create table', JSON.stringify(err));
          resolve(false);
        } else {
          resolve(true);
        }
      });
    } else {
      resolve(true);
    }
  });
};
