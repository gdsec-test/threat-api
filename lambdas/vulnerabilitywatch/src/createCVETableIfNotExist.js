const AWS = require('aws-sdk');
const { TABLE_DEFINITION, TABLE_NAME } = require('./const');
const Logger = require('./logger');

module.exports = async function createCVETableIfNotExist({ region }) {
  var dynamodb = new AWS.DynamoDB({ region, maxRetries: 3, sslEnabled: true });
  Logger.log('Checking if table CVE exists in DynamoDB');
  const tableNotExist = await new Promise((resolve) => {
    dynamodb.describeTable(
      {
        TableName: TABLE_NAME
      },
      function (err = {}, data) {
        if (err) {
          if (err.code === 'ResourceNotFoundException') {
            Logger.log('Table does not exist');
            resolve(true);
          } else {
            Logger.log('Unable to find table' + JSON.stringify(err));
          }
        } else {
          Logger.log('Table exist' + JSON.stringify(data));
          resolve(false);
        }
      }
    );
  });
  return new Promise((resolve) => {
    if (tableNotExist) {
      dynamodb.createTable(TABLE_DEFINITION, function (err, data) {
        if (err) {
          Logger.log('Unable to create table' + JSON.stringify(err));
          resolve(false);
        } else {
          Logger.log('Table created successfully');
          resolve(true);
        }
      });
    } else {
      Logger.log('Table already exists, no need to create');
      resolve(true);
    }
  });
};
